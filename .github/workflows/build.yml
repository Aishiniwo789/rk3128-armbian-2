name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and deploy stable kernel + patch strategy
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            echo "Fixing nested userpatches..."
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi
          echo ""

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF
          echo "✅ Board config created"
          echo ""

          echo "===== 3. Creating family config to use STABLE KERNEL ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration - using stable kernel
          
          # Explicitly set kernel version for legacy branch
          KERNEL_MAJOR_MINOR="4.4"
          
          # Use official stable kernel tree
          KERNELSOURCE="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"
          KERNELBRANCH="branch:linux-4.4.y"
          
          # U-Boot settings - use mainline u-boot with v2017.09 tag
          BOOTSOURCE="https://github.com/u-boot/u-boot.git"
          BOOTBRANCH="tag:v2017.09"
          BOOTPATCHDIR="v2017.09"
          
          # Family tweaks function (required)
          family_tweaks() { :; }
          EOF
          echo "✅ Family config created (using stable kernel)"
          cat userpatches/config/sources/families/rk3128.conf
          echo ""

          echo "===== 4. Providing kernel config file in the CORRECT location ====="
          # 确保文件在 userpatches/ 根目录下，这是 Armbian 查找用户配置的地方
          cat > userpatches/linux-rk3128-legacy.config << 'EOF'
          # 内核配置文件 - 用于 Rockchip RK3128, 基于 linux-4.4.y
          # 这是一个基础的配置，您可以根据需要添加更多选项
          
          # 架构
          CONFIG_ARM=y
          CONFIG_ARCH_ROCKCHIP=y
          CONFIG_ARCH_RK312X=y
          
          # 必要的文件系统
          CONFIG_EXT4_FS=y
          # CONFIG_BTRFS_FS is not set  (明确禁用 Btrfs)
          CONFIG_BTRFS_FS=n
          
          # 其他必要选项 (可以后续根据需要添加)
          CONFIG_AEABI=y
          CONFIG_FRAME_POINTER=y
          CONFIG_CMDLINE="console=ttyFIQ0 earlyprintk root=/dev/mmcblk0p3 rootwait"
          EOF
          echo "✅ Kernel config created at userpatches/linux-rk3128-legacy.config"
          cat userpatches/linux-rk3128-legacy.config
          echo ""

          echo "===== 5. Preparing RK3128 kernel patches directory ====="
          # 创建补丁目录，Armbian 会自动应用 userpatches/kernel/ 下的补丁
          mkdir -p userpatches/kernel/rk3128-4.4
          
          # 示例：创建设备树补丁 (如果需要)
          # cat > userpatches/kernel/rk3128-4.4/add-rk3128-box-dts.patch << 'EOF'
          # --- a/arch/arm/boot/dts/Makefile
          # +++ b/arch/arm/boot/dts/Makefile
          # @@ -XX,XX +XX,XX @@ dtb-$(CONFIG_ARCH_ROCKCHIP) += \
          #         rk3288-xxx.dtb \
          # +       rk3128-box.dtb \
          #         rk3xxx-xxx.dtb
          # EOF
          
          echo "✅ Kernel patches directory created at userpatches/kernel/rk3128-4.4/"
          echo ""

          echo "===== 6. Copying board and family configs to official paths ====="
          mkdir -p config/boards config/sources/families
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/
          # 注意：不复制 kernel config，让 Armbian 自动在 userpatches/ 中查找
          echo "✅ Board and family configs copied."
          ls -la config/boards/ config/sources/families/
          echo ""

          echo "===== 7. Final verification ====="
          echo "Board config: $(cat config/boards/rk3128-box.conf 2>/dev/null | head -3)"
          echo "Family config: $(cat config/sources/families/rk3128.conf 2>/dev/null | head -3)"
          echo "Kernel config: $(ls -la userpatches/linux-rk3128-legacy.config 2>/dev/null || echo 'Not found')"
          echo "Patches dir: $(ls -la userpatches/kernel/ 2>/dev/null || echo 'No patches yet')"
          echo ""

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
