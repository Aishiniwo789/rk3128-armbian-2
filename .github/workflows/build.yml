name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and provide COMPLETE family config with compiler flags
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            echo "Fixing nested userpatches..."
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi
          echo ""

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF
          echo "✅ Board config created:"
          cat userpatches/boards/rk3128-box.conf
          echo ""

          echo "===== 3. Creating family config with compiler flags for ARM32 ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration with ARM32 compiler flags
            
          # Source the common rockchip configuration if it exists
          source "${BASH_SOURCE%/*}/include/rockchip-common.inc" 2>/dev/null || true
            
          # Explicitly set kernel version for legacy branch
          KERNEL_MAJOR_MINOR="4.4"
            
          # Add compiler flags to fix ARM32 divmod issues
          KCFLAGS="${KCFLAGS} -mno-unaligned-access"
          
          # Add libgcc link flag to resolve __aeabi_uldivmod
          LDFLAGS="${LDFLAGS} -lgcc"
            
          # Family tweaks function
          family_tweaks() {
            : # No tweaks needed for basic functionality
          }
          EOF
          echo "✅ Family config created:"
          cat userpatches/config/sources/families/rk3128.conf
          echo ""

          echo "===== 4. Creating kernel config placeholder ====="
          mkdir -p config/kernel
          touch config/kernel/linux-rk3128-legacy.config
          echo "✅ Placeholder kernel config created"
          ls -la config/kernel/
          echo ""

          echo "===== 5. Creating kernel config fragment to DISABLE BTRFS ====="
          mkdir -p userpatches/config/kernel
          cat > userpatches/config/kernel/linux-rk3128-legacy.fragment << 'EOF'
          # Disable BTRFS filesystem
          CONFIG_BTRFS_FS=n
          EOF
          echo "✅ Kernel config fragment created"
          ls -la userpatches/config/kernel/
          echo ""

          echo "===== 6. Creating SIMPLIFIED kernel patch for Btrfs ====="
          mkdir -p userpatches/kernel/archive/rk3128-4.4
          
          # 使用更简单的补丁格式，只添加行而不依赖上下文
          cat > userpatches/kernel/archive/rk3128-4.4/0001-btrfs-add-libgcc.patch << 'EOF'
          --- a/fs/btrfs/Makefile
          +++ b/fs/btrfs/Makefile
          @@ -26,0 +27,3 @@
          +
          +# Fix ARM32 __aeabi_uldivmod undefined reference
          +KBUILD_LDFLAGS += -lgcc
          EOF
          echo "✅ Simplified kernel patch created"
          ls -la userpatches/kernel/archive/rk3128-4.4/
          echo ""

          echo "===== 7. Creating DEBUG script to verify patch application ====="
          mkdir -p userpatches/lib/functions
          cat > userpatches/lib/functions/debug.sh << 'EOF'
          function extension_prepare_config__debug() {
              display_alert "DEBUG: Checking patch application" "rk3128" "info"
              
              # 在内核源码准备好后检查补丁是否应用
              if [[ -d "${kerneldir}/fs/btrfs" ]]; then
                  if [[ -f "${kerneldir}/fs/btrfs/Makefile" ]]; then
                      if grep -q "KBUILD_LDFLAGS += -lgcc" "${kerneldir}/fs/btrfs/Makefile"; then
                          display_alert "✅ DEBUG: libgcc link found in Makefile" "Btrfs patch applied" "info"
                      else
                          display_alert "❌ DEBUG: libgcc link NOT found" "Btrfs patch missing" "err"
                      fi
                  fi
              fi
          }
          EOF
          echo "✅ Debug script created"
          echo ""

          echo "===== 8. Creating CUPS install script ====="
          cat > userpatches/customize-image.sh << 'EOF'
          #!/bin/bash
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y cups cups-client cups-filters printer-driver-all hplip network-manager
          cupsctl --remote-admin --remote-any --share-printers
          if ! id "pi" &>/dev/null; then
              useradd -m -G lpadmin -s /bin/bash pi
              echo "pi:armbian" | chpasswd
          fi
          apt-get clean
          EOF
          chmod +x userpatches/customize-image.sh
          echo "✅ CUPS install script created"

          echo "===== 9. Copying configs to official paths ====="
          mkdir -p config/boards config/sources/families config/kernel
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/
          cp userpatches/config/kernel/linux-rk3128-legacy.fragment config/kernel/
          echo "✅ Configs copied."
          ls -la config/boards/ config/sources/families/ config/kernel/
          echo ""

          echo "===== 10. Final verification ====="
          echo "Board config: $(cat config/boards/rk3128-box.conf 2>/dev/null | head -3)"
          echo "Family config: $(cat config/sources/families/rk3128.conf 2>/dev/null | head -5)"
          echo "Kernel fragment: $(ls -la config/kernel/linux-rk3128-legacy.fragment 2>/dev/null || echo 'Not found')"
          echo "Kernel patch: $(ls -la userpatches/kernel/archive/rk3128-4.4/0001-btrfs-add-libgcc.patch 2>/dev/null || echo 'Not found')"
          echo ""

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio gcc-arm-linux-gnueabihf libgcc-10-dev-armhf-cross

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
