name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and apply source-level patches via hook
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            echo "Fixing nested userpatches..."
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi
          echo ""

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF
          echo "✅ Board config created at userpatches/boards/rk3128-box.conf"
          cat userpatches/boards/rk3128-box.conf
          echo ""

          echo "===== 3. Creating minimal family config ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration - minimal
          KERNEL_MAJOR_MINOR="4.4"
          family_tweaks() { :; }
          EOF
          echo "✅ Family config created"
          echo ""

          echo "===== 4. Creating custom kernel config hook to APPLY KERNEL PATCHES ====="
          mkdir -p userpatches/lib/functions
          cat > userpatches/lib/functions/custom_kernel_config.sh << 'EOF'
          function extension_prepare_config__custom_kernel_config() {
              display_alert "Preparing custom kernel config hook" "rk3128: Will apply BTRFS source patches" "info"
          }

          function custom_kernel_config() {
              # 此钩子在源码准备好后被调用
              if [[ -d "${kerneldir}/fs/btrfs" ]]; then
                  display_alert "Custom kernel config" "Applying Arnd Bergmann's static inline patch to super.c" "info"
                  
                  # 定义补丁内容：将 super.c 中的两个关键函数改为 static inline
                  # 这是基于 2018 年 Arnd Bergmann 的修复方案 [citation:5]
                  PATCH_FILE="${kerneldir}/fs/btrfs/super.c"
                  if [[ -f "$PATCH_FILE" ]]; then
                      # 备份原文件
                      cp "$PATCH_FILE" "${PATCH_FILE}.bak"
                      
                      # 应用补丁：将 btrfs_cmp_device_free_bytes 和 btrfs_calc_avail_data_space 改为 static inline
                      sed -i 's/^static int btrfs_cmp_device_free_bytes/static inline int btrfs_cmp_device_free_bytes/' "$PATCH_FILE"
                      sed -i 's/^static int btrfs_calc_avail_data_space/static inline int btrfs_calc_avail_data_space/' "$PATCH_FILE"
                      
                      display_alert "Patched super.c" "Functions changed to static inline" "info"
                      
                      # 可选：也可以尝试将其他地方的 '/' 除法改为 do_div() [citation:7]
                      # 但这更复杂，先应用最直接的 static inline 方案
                  else
                      display_alert "super.c not found!" "BTRFS source structure unexpected" "err"
                  fi
                  
                  # 再次确保 .config 中相关选项被禁用，作为保险
                  if [[ -f .config ]]; then
                      sed -i '/CONFIG_BTRFS_FS/d' .config
                      echo "# CONFIG_BTRFS_FS is not set" >> .config
                      make ARCH=arm olddefconfig
                  fi
              else
                  display_alert "BTRFS source directory not found" "Maybe already removed?" "debug"
              fi
          }
          EOF
          echo "✅ Custom kernel config hook created (with source patching)"
          cat userpatches/lib/functions/custom_kernel_config.sh
          echo ""

          echo "===== 5. Copying board and family configs to official paths ====="
          mkdir -p config/boards config/sources/families
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/
          echo "✅ Board and family configs copied."
          echo ""

          echo "===== 6. Final verification ====="
          echo "Board config: $(cat config/boards/rk3128-box.conf 2>/dev/null | head -3)"
          echo "Custom hook (with patching): $(ls -la userpatches/lib/functions/custom_kernel_config.sh 2>/dev/null || echo 'Not found')"
          echo ""

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
