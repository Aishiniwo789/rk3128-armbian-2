name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and provide all configs with BTRFS completely disabled
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            echo "Fixing nested userpatches..."
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi
          echo ""

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF
          echo "✅ Board config created at userpatches/boards/rk3128-box.conf"
          cat userpatches/boards/rk3128-box.conf
          echo ""

          echo "===== 3. Creating minimal family config ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration - minimal
          
          # Explicitly set kernel version for legacy branch (required)
          KERNEL_MAJOR_MINOR="4.4"
          
          # Family tweaks function (required)
          family_tweaks() {
            : # No tweaks needed for basic functionality
          }
          EOF
          echo "✅ Family config created at userpatches/config/sources/families/rk3128.conf"
          cat userpatches/config/sources/families/rk3128.conf
          echo ""

          echo "===== 4. Creating user kernel config to COMPLETELY DISABLE BTRFS ====="
          # 根据官方文档，用户内核配置文件应直接放在 userpatches/ 根目录下
          cat > userpatches/linux-rk3128-legacy.config << 'EOF'
          # 用户提供的内核配置文件 - 完全禁用 BTRFS
          # 基于 ARM 32-bit 上 Btrfs 的已知问题
          
          # 核心：完全禁用 Btrfs 文件系统（不构建为模块，也不内置）
          CONFIG_BTRFS_FS=n
          
          # 明确禁用所有相关的 Btrfs 特性，确保不会意外启用
          # 这些选项可能依赖 CONFIG_BTRFS_FS，但为了安全起见全部禁用
          CONFIG_BTRFS_FS_POSIX_ACL=n
          CONFIG_BTRFS_FS_CHECK_INTEGRITY=n
          CONFIG_BTRFS_FS_RUN_SANITY_TESTS=n
          CONFIG_BTRFS_DEBUG=n
          CONFIG_BTRFS_ASSERT=n
          CONFIG_BTRFS_FS_REF_VERIFY=n
          
          # 确保其他可能依赖 Btrfs 的选项也被禁用
          # 这些选项可能在默认配置中被启用
          CONFIG_BTRFS_FS_STATS=n
          CONFIG_BTRFS_FS_REPORT_LOGICAL_ADDRESS=n
          CONFIG_BTRFS_FS_SUBVOL_SYSFS=n
          CONFIG_BTRFS_FS_HAS_SUBVOLUME=n
          CONFIG_BTRFS_FS_HAS_CSUM=n
          
          # 明确禁止将 Btrfs 编译为模块（双重保险）
          # CONFIG_BTRFS_FS is not set
          # CONFIG_BTRFS_FS_MODULE is not set
          EOF
          echo "✅ User kernel config created at userpatches/linux-rk3128-legacy.config"
          cat userpatches/linux-rk3128-legacy.config
          echo ""

          echo "===== 5. Creating a kernel config fragment for additional safety ====="
          mkdir -p userpatches/config/kernel
          cat > userpatches/config/kernel/linux-rk3128-legacy.fragment << 'EOF'
          # 内核配置片段 - 确保 Btrfs 完全禁用
          # 这个片段会在内核配置流程中被合并
          
          # 明确禁用 Btrfs 及其所有相关选项
          CONFIG_BTRFS_FS=n
          CONFIG_BTRFS_FS_POSIX_ACL=n
          CONFIG_BTRFS_FS_CHECK_INTEGRITY=n
          CONFIG_BTRFS_FS_RUN_SANITY_TESTS=n
          CONFIG_BTRFS_DEBUG=n
          CONFIG_BTRFS_ASSERT=n
          EOF
          echo "✅ Kernel config fragment created at userpatches/config/kernel/linux-rk3128-legacy.fragment"
          echo ""

          echo "===== 6. Creating custom kernel config hook as ultimate safeguard ====="
          mkdir -p userpatches/lib/functions
          cat > userpatches/lib/functions/custom_kernel_config.sh << 'EOF'
          function extension_prepare_config__custom_kernel_config() {
              display_alert "Preparing custom kernel config hook" "rk3128: Final BTRFS disable check" "info"
          }

          function custom_kernel_config() {
              # 此钩子在内核配置流程的最后阶段被调用
              if [[ -f .config ]]; then
                  display_alert "Custom kernel config" "Performing final check for BTRFS" "info"
                  
                  # 检查并确保 BTRFS 被完全禁用
                  if grep -q "CONFIG_BTRFS_FS=y" .config || grep -q "CONFIG_BTRFS_FS=m" .config; then
                      display_alert "WARNING: BTRFS still enabled in final config, forcing disable" "BTRFS" "wrn"
                      # 直接修改 .config 文件
                      sed -i '/CONFIG_BTRFS_FS/d' .config
                      echo "# CONFIG_BTRFS_FS is not set" >> .config
                      sed -i '/CONFIG_BTRFS_FS_POSIX_ACL/d' .config
                      echo "# CONFIG_BTRFS_FS_POSIX_ACL is not set" >> .config
                      sed -i '/CONFIG_BTRFS_FS_CHECK_INTEGRITY/d' .config
                      echo "# CONFIG_BTRFS_FS_CHECK_INTEGRITY is not set" >> .config
                      sed -i '/CONFIG_BTRFS_FS_RUN_SANITY_TESTS/d' .config
                      echo "# CONFIG_BTRFS_FS_RUN_SANITY_TESTS is not set" >> .config
                      sed -i '/CONFIG_BTRFS_DEBUG/d' .config
                      echo "# CONFIG_BTRFS_DEBUG is not set" >> .config
                      sed -i '/CONFIG_BTRFS_ASSERT/d' .config
                      echo "# CONFIG_BTRFS_ASSERT is not set" >> .config
                      
                      # 运行 olddefconfig 使修改生效并解决依赖关系
                      make ARCH=arm olddefconfig
                      display_alert "BTRFS forcibly disabled in final config" "BTRFS" "info"
                  else
                      display_alert "BTRFS already disabled in final config" "BTRFS" "ok"
                  fi
                  
                  # 最终验证
                  if grep -q "CONFIG_BTRFS_FS=y\|CONFIG_BTRFS_FS=m" .config; then
                      display_alert "ERROR: Failed to disable BTRFS" "BTRFS" "err"
                  else
                      display_alert "Verified: BTRFS is completely disabled" "BTRFS" "ok"
                  fi
              fi
          }
          EOF
          echo "✅ Custom kernel config hook created at userpatches/lib/functions/custom_kernel_config.sh"
          echo ""

          echo "===== 7. Copying board and family configs to official paths ====="
          mkdir -p config/boards config/sources/families
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/
          # 注意：不复制内核配置文件到 config/kernel/，让 Armbian 自动在 userpatches/ 中查找
          echo "✅ Board and family configs copied."
          ls -la config/boards/ config/sources/families/
          echo ""

          echo "===== 8. Final verification ====="
          echo "Board config: $(cat config/boards/rk3128-box.conf 2>/dev/null | head -3)"
          echo "Family config: $(cat config/sources/families/rk3128.conf 2>/dev/null | head -3)"
          echo "User kernel config: $(ls -la userpatches/linux-rk3128-legacy.config 2>/dev/null || echo 'Not found')"
          echo "Kernel fragment: $(ls -la userpatches/config/kernel/linux-rk3128-legacy.fragment 2>/dev/null || echo 'Not found')"
          echo "Custom hook: $(ls -la userpatches/lib/functions/custom_kernel_config.sh 2>/dev/null || echo 'Not found')"
          echo ""

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
