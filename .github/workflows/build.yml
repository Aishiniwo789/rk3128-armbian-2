name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Debug - list userpatches content
        working-directory: armbian-build
        run: |
          echo "=== Content of userpatches/ ==="
          ls -la userpatches/
          echo "=== Content of userpatches/boards/ (if exists) ==="
          ls -la userpatches/boards/ || echo "boards/ directory not found"
          echo "=== Content of userpatches/ (full tree) ==="
          find userpatches -type f | head -20

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_ONLY: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_ONLY=$KERNEL_ONLY KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
