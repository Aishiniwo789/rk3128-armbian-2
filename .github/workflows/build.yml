name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and deploy FINAL SOLUTION
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF

          echo "===== 3. Creating family config with STABLE KERNEL ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration
          KERNEL_MAJOR_MINOR="4.4"
          KERNELSOURCE="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git"
          KERNELBRANCH="branch:linux-4.4.y"
          BOOTSOURCE="https://github.com/u-boot/u-boot.git"
          BOOTBRANCH="tag:v2017.09"
          BOOTPATCHDIR="v2017.09"
          family_tweaks() { :; }
          EOF

          echo "===== 4. Providing kernel config file ====="
          cat > userpatches/linux-rk3128-legacy.config << 'EOF'
          CONFIG_ARM=y
          CONFIG_ARCH_ROCKCHIP=y
          CONFIG_ARCH_RK312X=y
          CONFIG_EXT4_FS=y
          CONFIG_BTRFS_FS=n
          CONFIG_AEABI=y
          CONFIG_FRAME_POINTER=y
          CONFIG_CMDLINE="console=ttyFIQ0 earlyprintk root=/dev/mmcblk0p3 rootwait"
          EOF

          echo "===== 5. Creating kernel config hook with MULTI-LAYER PROTECTION ====="
          mkdir -p userpatches/lib/functions
          cat > userpatches/lib/functions/custom_kernel_config.sh << 'EOF'
          function extension_prepare_config__custom_kernel_config() {
              display_alert "Preparing custom kernel config hook" "rk3128: Deploying multi-layer BTRFS protection" "info"
          }

          function custom_kernel_config() {
              if [[ -d "${kerneldir}/fs/btrfs" ]]; then
                  display_alert "MULTI-LAYER PROTECTION" "Layer 1: Patching specific functions" "info"
                  
                  # 补丁1: super.c中的两个关键函数改为static inline
                  if [[ -f "${kerneldir}/fs/btrfs/super.c" ]]; then
                      sed -i 's/^static int btrfs_cmp_device_free_bytes/static inline int btrfs_cmp_device_free_bytes/' "${kerneldir}/fs/btrfs/super.c"
                      sed -i 's/^static int btrfs_calc_avail_data_space/static inline int btrfs_calc_avail_data_space/' "${kerneldir}/fs/btrfs/super.c"
                      display_alert "Layer 1 applied" "super.c patched with static inline" "info"
                  fi
                  
                  # 补丁2: volumes.c中可能的除法问题
                  if [[ -f "${kerneldir}/fs/btrfs/volumes.c" ]]; then
                      # 搜索并替换常见的除法模式
                      sed -i 's/\([a-zA-Z0-9_]\+\) \/ \([0-9]\+\);/div_u64(\1, \2);/g' "${kerneldir}/fs/btrfs/volumes.c"
                      display_alert "Layer 2 applied" "volumes.c patched for div patterns" "info"
                  fi
                  
                  # 补丁3: extent-tree.c中的除法问题
                  if [[ -f "${kerneldir}/fs/btrfs/extent-tree.c" ]]; then
                      sed -i 's/\([a-zA-Z0-9_]\+\) % \([0-9]\+\);/do_div(\1, \2);/g' "${kerneldir}/fs/btrfs/extent-tree.c"
                      display_alert "Layer 3 applied" "extent-tree.c patched for modulo patterns" "info"
                  fi
                  
                  # 补丁4: 最终保险 - 删除可能导致问题的文件
                  display_alert "MULTI-LAYER PROTECTION" "Layer 4: Removing risky files as last resort" "info"
                  # 删除已知有问题的文件，但不删除整个目录（保留目录结构避免Kbuild出错）
                  find "${kerneldir}/fs/btrfs" -name "*.c" -exec grep -l "__aeabi_uldivmod" {} \; | while read file; do
                      display_alert "Removing problematic file" "$(basename $file)" "wrn"
                      mv "$file" "$file.bak"
                  done
                  
                  display_alert "MULTI-LAYER PROTECTION" "All layers deployed" "info"
              fi
              
              # 配置层面的最终保障
              if [[ -f .config ]]; then
                  sed -i '/CONFIG_BTRFS_FS/d' .config
                  echo "# CONFIG_BTRFS_FS is not set" >> .config
                  make ARCH=arm olddefconfig
              fi
          }
          EOF

          echo "===== 6. Copying configs ====="
          mkdir -p config/boards config/sources/families
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
