name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and provide board & family configs
        working-directory: armbian-build
        run: |
          echo "===== 1. Checking current userpatches content ====="
          ls -la userpatches/
          echo ""
          
          # 修复可能的嵌套 userpatches 目录
          if [ -d "userpatches/userpatches" ]; then
            echo "⚠️  Detected nested userpatches directory. Fixing..."
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
            echo "✅ Fixed: moved contents to userpatches/"
          else
            echo "✅ No nested userpatches directory found."
          fi
          echo ""
          
          echo "===== 2. Verifying boards directory ====="
          if [ -d "userpatches/boards" ]; then
            echo "✅ boards directory exists."
            ls -la userpatches/boards/
          else
            echo "❌ boards directory missing! Creating it."
            mkdir -p userpatches/boards
          fi
          echo ""
          
          echo "===== 3. Checking rk3128-box.conf in userpatches/boards/ ====="
          if [ -f "userpatches/boards/rk3128-box.conf" ]; then
            echo "✅ rk3128-box.conf found."
            cat userpatches/boards/rk3128-box.conf
          else
            echo "❌ rk3128-box.conf not found! Searching..."
            find userpatches -name "rk3128-box.conf" -type f
            exit 1
          fi
          echo ""
          
          echo "===== 4. Creating family config for rk3128 (rk3128.conf) ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
# Rockchip RK3128 family configuration (minimal)
source "${BASH_SOURCE%/*}/include/rockchip-common.inc"

# Kernel settings
KERNELPATCHDIR="rk3128"
KERNELSOURCE="https://github.com/armbian/linux-rockchip"
KERNELBRANCH="branch:linux-4.4-rk3128"

# U-Boot settings
BOOTSOURCE="https://github.com/armbian/u-boot-rockchip"
BOOTBRANCH="branch:v2017.09-rk3128"

# Family tweaks (empty for now)
family_tweaks() { :; }
EOF
          echo "✅ Created userpatches/config/sources/families/rk3128.conf"
          cat userpatches/config/sources/families/rk3128.conf
          echo ""
          
          echo "===== 5. Fixing line endings and permissions ====="
          sudo apt-get update && sudo apt-get install -y dos2unix
          find userpatches -name "*.conf" -exec dos2unix {} \;
          find userpatches -name "*.sh" -exec chmod +x {} \;
          echo "✅ Permissions and line endings fixed."
          echo ""
          
          echo "===== 6. Copy board config to official path (config/boards/) ====="
          mkdir -p config/boards
          cp userpatches/boards/rk3128-box.conf config/boards/
          echo "✅ Copied to config/boards/rk3128-box.conf"
          ls -la config/boards/rk3128-box.conf
          echo ""
          
          echo "===== 7. Copy family config to official path (config/sources/families/) ====="
          mkdir -p config/sources/families
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/
          echo "✅ Copied to config/sources/families/rk3128.conf"
          ls -la config/sources/families/rk3128.conf
          echo ""
          
          echo "===== 8. Final verification ====="
          echo "Board config: $(ls -la config/boards/rk3128-box.conf 2>/dev/null || echo 'Not found')"
          echo "Family config: $(ls -la config/sources/families/rk3128.conf 2>/dev/null || echo 'Not found')"
          echo ""

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y qemu-user-static binfmt-support debootstrap device-tree-compiler pv bc build-essential git dosfstools uuid-runtime udev kmod cpio

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_ONLY: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_ONLY=$KERNEL_ONLY KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
