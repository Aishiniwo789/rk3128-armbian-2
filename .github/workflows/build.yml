name: Build Armbian for RK3128

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Armbian build repository
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          path: armbian-build

      - name: Checkout userpatches (current repository)
        uses: actions/checkout@v4
        with:
          path: armbian-build/userpatches

      - name: Fix nested structure and provide basic config
        working-directory: armbian-build
        run: |
          set -e
          echo "===== 1. Fixing possible nested userpatches ====="
          if [ -d "userpatches/userpatches" ]; then
            mv userpatches/userpatches/* userpatches/ 2>/dev/null || true
            mv userpatches/userpatches/.[!.]* userpatches/ 2>/dev/null || true
            rmdir userpatches/userpatches 2>/dev/null || true
          fi

          echo "===== 2. Creating board config ====="
          mkdir -p userpatches/boards
          cat > userpatches/boards/rk3128-box.conf << 'EOF'
          BOARD_NAME="RK3128 box"
          BOARDFAMILY="rk3128"
          ARCH="armhf"
          BRANCH="legacy"
          KERNEL_TARGET="legacy"
          EOF

          echo "===== 3. Creating family config with GitHub kernel mirror ====="
          mkdir -p userpatches/config/sources/families
          cat > userpatches/config/sources/families/rk3128.conf << 'EOF'
          # Rockchip RK3128 family configuration
          KERNEL_MAJOR_MINOR="4.4"
          KERNELSOURCE="https://github.com/Aishiniwo789/firefly-rk3128.git"
          KERNELBRANCH="branch:master"
          BOOTSOURCE="https://github.com/u-boot/u-boot.git"
          BOOTBRANCH="tag:v2017.09"
          BOOTPATCHDIR="v2017.09"
          LDFLAGS="${LDFLAGS} -lgcc"
          family_tweaks() { :; }
          EOF

          echo "===== 4. Creating user kernel config (disable BTRFS) ====="
          cat > userpatches/linux-rk3128-legacy.config << 'EOF'
          CONFIG_ARM=y
          CONFIG_ARCH_ROCKCHIP=y
          CONFIG_ARCH_RK312X=y
          CONFIG_EXT4_FS=y
          # CONFIG_BTRFS_FS is not set
          CONFIG_AEABI=y
          CONFIG_FRAME_POINTER=y
          CONFIG_CMDLINE="console=ttyFIQ0 earlyprintk root=/dev/mmcblk0p3 rootwait"
          EOF

          echo "===== 5. Creating kernel config fragment ====="
          mkdir -p userpatches/config/kernel
          cat > userpatches/config/kernel/linux-rk3128-legacy.fragment << 'EOF'
          CONFIG_BTRFS_FS=n
          EOF

          echo "===== 6. Creating kernel patches ====="
          mkdir -p userpatches/kernel/archive/rk3128-4.4
          
          # Patch 1: Fix compiler-gcc13.h missing error
          cat > userpatches/kernel/archive/rk3128-4.4/0001-fix-compiler-gcc-header.patch << 'EOF'
--- a/include/linux/compiler-gcc.h
+++ b/include/linux/compiler-gcc.h
@@ -97,7 +97,9 @@
 #endif
 #endif
 
-#if GCC_VERSION >= 40600
+#define GCC_VERSION (__GNUC__ * 10000 + __GNUC_MINOR__ * 100 + __GNUC_PATCHLEVEL__)
+
+#if defined(GCC_VERSION) && GCC_VERSION >= 40600
 #define __compiletime_object_size(obj) __builtin_object_size(obj, 0)
 #endif
EOF

          # Patch 2: Fix yylloc multiple definition error
          cat > userpatches/kernel/archive/rk3128-4.4/0002-scripts-dtc-remove-redundant-yylloc.patch << 'EOF'
--- a/scripts/dtc/dtc-lexer.l
+++ b/scripts/dtc/dtc-lexer.l
@@ -20,10 +20,6 @@
 
 #include "srcpos.h"
 #include "dtc-parser.tab.h"
-
-YYLTYPE yylloc;
-
 extern bool treesource_error;
 
 /* CAUTION: this will stop working if we ever use yyless() or yyunput() */
EOF
          echo "✅ Kernel patches created"
          
          # 验证补丁文件
          echo "===== Patch files created ====="
          ls -la userpatches/kernel/archive/rk3128-4.4/
          echo "===== Patch 1 content ====="
          cat userpatches/kernel/archive/rk3128-4.4/0001-fix-compiler-gcc-header.patch
          echo "===== Patch 2 content ====="
          cat userpatches/kernel/archive/rk3128-4.4/0002-scripts-dtc-remove-redundant-yylloc.patch

          echo "===== 7. Creating CUPS install script ====="
          cat > userpatches/customize-image.sh << 'EOF'
          #!/bin/bash
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y cups cups-client cups-filters printer-driver-all hplip
          cupsctl --remote-admin --remote-any --share-printers
          if ! id "pi" &>/dev/null; then
              useradd -m -G lpadmin -s /bin/bash pi
              echo "pi:armbian" | chpasswd
          fi
          apt-get clean
          EOF
          chmod +x userpatches/customize-image.sh

          echo "===== 8. Copying board and family configs ====="
          mkdir -p config/boards config/sources/families
          cp userpatches/boards/rk3128-box.conf config/boards/
          cp userpatches/config/sources/families/rk3128.conf config/sources/families/

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support debootstrap \
            device-tree-compiler pv bc build-essential git dosfstools uuid-runtime \
            udev kmod cpio gcc-arm-linux-gnueabihf libgcc-10-dev-armhf-cross \
            bison flex

      - name: Clean cache
        working-directory: armbian-build
        run: rm -rf output/cache

      - name: Build Armbian with patch debugging
        working-directory: armbian-build
        env:
          BOARD: rk3128-box
          BRANCH: legacy
          RELEASE: bullseye
          BUILD_MINIMAL: no
          BUILD_DESKTOP: no
          KERNEL_CONFIGURE: no
          COMPRESS_OUTPUTIMAGE: sha,img
          ARCH: armhf
          USERPATCHES_PATH: ./userpatches
          IGNORE_UPDATES: yes
        run: |
          # 显示当前目录结构
          echo "===== Current directory ====="
          pwd
          
          # 显示补丁目录内容
          echo "===== Kernel patches directory ====="
          ls -la userpatches/kernel/archive/rk3128-4.4/
          
          # 显示补丁内容
          echo "===== Patch 1 content ====="
          cat userpatches/kernel/archive/rk3128-4.4/0001-fix-compiler-gcc-header.patch
          
          echo "===== Patch 2 content ====="
          cat userpatches/kernel/archive/rk3128-4.4/0002-scripts-dtc-remove-redundant-yylloc.patch
          
          # 检查内核源码目录
          echo "===== Checking kernel source ====="
          if [ -d "cache/sources" ]; then
            echo "cache/sources exists"
            ls -la cache/sources/
          else
            echo "cache/sources not found yet"
          fi
          
          # 运行编译并捕获详细输出
          echo "===== Starting compilation ====="
          ./compile.sh BOARD=$BOARD BRANCH=$BRANCH RELEASE=$RELEASE BUILD_MINIMAL=$BUILD_MINIMAL BUILD_DESKTOP=$BUILD_DESKTOP KERNEL_CONFIGURE=$KERNEL_CONFIGURE COMPRESS_OUTPUTIMAGE=$COMPRESS_OUTPUTIMAGE ARCH=$ARCH 2>&1 | tee compile.log
          
          # 检查编译是否成功
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "❌ Compilation failed with exit code ${PIPESTATUS[0]}"
            echo "===== Last 100 lines of compile.log ====="
            tail -100 compile.log
            exit ${PIPESTATUS[0]}
          fi
          
          echo "✅ Compilation successful!"

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-printserver
          path: armbian-build/output/images/*.img
          retention-days: 7
